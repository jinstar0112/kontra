function qFactory(t,e){function n(t,e,i){var r;if(t)if(s(t))for(r in t)"prototype"==r||"length"==r||"name"==r||t.hasOwnProperty&&!t.hasOwnProperty(r)||e.call(i,t[r],r);else if(t.forEach&&t.forEach!==n)t.forEach(e,i);else if(u(t))for(r=0;r<t.length;r++)e.call(i,t[r],r);else for(r in t)t.hasOwnProperty(r)&&e.call(i,t[r],r);return t}function i(t){return t}function r(t){return h(t)}function o(t){var e=c(),i=0,r=u(t)?[]:{};return n(t,function(t,n){i++,f(t).then(function(t){r.hasOwnProperty(n)||(r[n]=t,--i||e.resolve(r))},function(t){r.hasOwnProperty(n)||e.reject(t)},function(t){r.hasOwnProperty(n)||e.notify(t)})}),0===i&&e.resolve(r),e.promise}var a={}.toString,s=function(t){return"function"==typeof t},u=function(t){return"[object Array]"===a.call(t)},c=function(){var n,o,a=[];return o={resolve:function(e){if(a){var i=a;a=void 0,n=f(e),i.length&&t(function(){for(var t,e=0,r=i.length;r>e;e++)t=i[e],n.then(t[0],t[1],t[2])})}},reject:function(t){o.resolve(d(t))},notify:function(e){if(a){var n=a;a.length&&t(function(){for(var t,i=0,r=n.length;r>i;i++)t=n[i],t[2](e)})}},promise:{then:function(t,o,u){var f=c(),h=function(n){try{f.resolve((s(t)?t:i)(n))}catch(r){f.reject(r),e(r)}},d=function(t){try{f.resolve((s(o)?o:r)(t))}catch(n){f.reject(n),e(n)}},l=function(t){try{f.notify((s(u)?u:i)(t))}catch(n){e(n)}};return a?a.push([h,d,l]):n.then(h,d,l),f.promise},"catch":function(t){return this.then(null,t)},"finally":function(t){function e(t,e){var n=c();return e?n.resolve(t):n.reject(t),n.promise}function n(n,r){var o=null;try{o=(t||i)()}catch(a){return e(a,!1)}return o&&s(o.then)?o.then(function(){return e(n,r)},function(t){return e(t,!1)}):e(n,r)}return this.then(function(t){return n(t,!0)},function(t){return n(t,!1)})}}}},f=function(e){return e&&s(e.then)?e:{then:function(n){var i=c();return t(function(){i.resolve(n(e))}),i.promise}}},h=function(t){var e=c();return e.reject(t),e.promise},d=function(n){return{then:function(i,o){var a=c();return t(function(){try{a.resolve((s(o)?o:r)(n))}catch(t){a.reject(t),e(t)}}),a.promise}}},l=function(n,o,a,u){var d,l=c(),m=function(t){try{return(s(o)?o:i)(t)}catch(n){return e(n),h(n)}},p=function(t){try{return(s(a)?a:r)(t)}catch(n){return e(n),h(n)}},v=function(t){try{return(s(u)?u:i)(t)}catch(n){e(n)}};return t(function(){f(n).then(function(t){d||(d=!0,l.resolve(f(t).then(m,p,v)))},function(t){d||(d=!0,l.resolve(p(t)))},function(t){d||l.notify(v(t))})}),l.promise};return{defer:c,reject:h,when:l,all:o}}window.q=qFactory(function(t){setTimeout(function(){t()},0)},function(t){console.error("qLite: "+t.stack)});var kontra=function(t){var e=/(jpeg|jpg|gif|png)$/,n=/(wav|mp3|ogg|aac|m4a)$/;t.images={},t.audios={},t.data={},t.assetPaths={images:"",audios:"",data:""};var i=new Audio;return t.canUse=t.canUse||{},t.canUse.wav="",t.canUse.mp3=i.canPlayType("audio/mpeg;").replace(/^no$/,""),t.canUse.ogg=i.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),t.canUse.aac=i.canPlayType("audio/aac;").replace(/^no$/,""),t.canUse.m4a=(i.canPlayType("audio/x-m4a;")||t.canUse.aac).replace(/^no$/,""),t.getAssetExtension=function(t){return t.substr((~-t.lastIndexOf(".")>>>0)+2)},t.getAssetType=function(t){var i=this.getAssetExtension(t);return i.match(e)?"Image":i.match(n)?"Audio":"Data"},t.getAssetName=function(t){return t.replace(/\.[^/.]+$/,"")},t}(kontra||{}),kontra=function(t,e){return t.loadAssets=function(){var n,i,r=e.defer(),o=[],a=0,s=arguments.length;arguments.length||r.resolve();for(var u,c=0;u=arguments[c];c++)i=Array.isArray(u)?u[0]:u,n=this.getAssetType(i),function(e){o.push(e.promise),t["load"+n](i).then(function(){e.resolve(),r.notify({loaded:++a,total:s})},function(t){e.reject(t)})}(e.defer());return e.all(o).then(function(){r.resolve()},function(t){r.reject(t)}),r.promise},t.loadImage=function(n){var i=e.defer(),r=this.getAssetName(n),o=new Image;return n=this.assetPaths.images+n,o.onload=function(){t.images[r]=t.images[n]=this,i.resolve(this)},o.onerror=function(){i.reject("Unable to load image "+n)},o.src=n,i.promise},t.loadAudio=function(n){var i,r,o,a,s=e.defer();Array.isArray(n)||(n=[n]);for(var u=0;i=n[u];u++)if(this.canUse[this.getAssetExtension(i)]){o=i;break}return o?(r=this.getAssetName(o),a=new Audio,i=this.assetPaths.audios+o,a.addEventListener("canplay",function(){t.audios[r]=t.audios[i]=this,s.resolve(this)}),a.onerror=function(){s.reject("Unable to load audio "+i)},a.src=i,a.preload="auto",a.load()):s.reject("Browser cannot play any of the audio formats provided"),s.promise},t.loadData=function(n){var i=e.defer(),r=new XMLHttpRequest,o=this.getAssetName(n),a=this.assetPaths.data+n;return r.addEventListener("load",function(){if(200!==r.status)return void i.reject(r.responseText);try{var e=JSON.parse(r.responseText);t.data[o]=t.data[a]=e,i.resolve(e)}catch(n){var s=r.responseText;t.data[o]=t.data[a]=s,i.resolve(s)}}),r.open("GET",a,!0),r.send(),i.promise},t}(kontra||{},q),kontra=function(t,e){return t.bundles={},t.createBundle=function(t,e){this.bundles[t]||(this.bundles[t]=e||[])},t.loadBundles=function(){for(var t,n,i=e.defer(),r=[],o=0,a=0,s=0;n=arguments[s];s++)(t=this.bundles[n])?(a+=t.length,r.push(this.loadAssets.apply(this,t))):i.reject("Bundle '"+n+"' has not been created.");return e.all(r).then(function(){i.resolve()},function(t){i.reject(t)},function(){i.notify({loaded:++o,total:a})}),i.promise},t}(kontra||{},q),kontra=function(t,e){return t.loadManifest=function(n){var i,r=e.defer();return t.loadData(n).then(function(e){t.assetPaths.images=e.imagePath||"",t.assetPaths.audios=e.audioPath||"",t.assetPaths.data=e.dataPath||"";for(var n,o=0;n=e.bundles[o];o++)t.createBundle(n.name,n.assets);return e.loadBundles?(i="all"===e.loadBundles?Object.keys(t.bundles||{}):Array.isArray(e.loadBundles)?e.loadBundles:[e.loadBundles],void t.loadBundles.apply(t,i).then(function(){r.resolve()},function(t){r.reject(t)},function(t){r.notify(t)})):void r.resolve()},function(t){r.reject(t)}),r.promise},t}(kontra||{},q),kontra=function(t,e){"use strict";return t.init=function(n){if(n=n||{},t.isString(n.canvas))this.canvas=e.getElementById(n.canvas);else if(t.isCanvas(n.canvas))this.canvas=n.canvas;else if(this.canvas=e.getElementsByTagName("canvas")[0],!this.canvas){var i=new ReferenceError("No canvas element found.");return void t.logError(i,"You must provide a canvas element for the game.")}this.context=this.canvas.getContext("2d"),this.gameWidth=this.canvas.width,this.gameHeight=this.canvas.height},t.logError=function(t,e){t.originalMessage=t.message,t.message="Kontra: "+e+"\n	"+t.stack,console.error(t.message)},t.noop=function(){},t.isArray=Array.isArray,t.isString=function(t){return"string"==typeof t},t.isNumber=function(t){return"number"==typeof t},t.isImage=function(t){return t&&"img"===t.nodeName.toLowerCase()},t.isCanvas=function(t){return t&&"canvas"===t.nodeName.toLowerCase()},t}(kontra||{},document),kontra=function(t,e,n){"use strict";t.GameLoop=function(e){function r(){n.hidden||(f=0)}if(e=e||{},"function"!=typeof e.update||"function"!=typeof e.render){var o=new ReferenceError("Required functions not found");return void t.logError(o,"You must provide update() and render() functions to create a game loop.")}var a,s,u,c=e.fps||60,f=0,h=0,d=1e3/c,l=e.update,m=e.render,p=this;n.addEventListener("visibilitychange",r,!1),this.start=function(){f=0,requestAnimationFrame(this.frame)},this.frame=function(){for(u=requestAnimationFrame(p.frame),a=i(),s=a-(f||a),f=a,h+=s;h>=d;)l(d),h-=d;m()},this.stop=function(){cancelAnimationFrame(u)}};var i=function(){return e.performance&&e.performance.now?function(){return e.performance.now()}:function(){return(new Date).getTime()}}();return t}(kontra||{},window,document),kontra=function(t,e){"use strict";function n(t){return"number"==typeof t.which?t.which:t.keyCode}function i(t){var e=[];t=t.trim().replace("++","+plus");for(var n,i=0;n=m[i];i++)-1!==t.indexOf(n)&&(e.push(n),t=t.replace(n,""));return t=t.replace(/\+/g,"").toLowerCase(),d[t]?e.push("shift+"+d[t]):t&&e.push(t),e.join("+")}function r(t){for(var e=[],i=0;modifier=m[i];i++)t[modifier+"Key"]&&e.push(modifier);var r=f[n(t)];return-1===e.indexOf(r)&&e.push(r),e.join("+")}function o(t){for(var e,n=r(t),i=0,o=n.split("+");e=o[i];i++)c[e]=!0;u[n]&&(u[n](t,n),t.preventDefault())}function a(t){var e=f[n(t)];c[e]=!1,l[e]&&(c[l[e]]=!1)}function s(){c={}}for(var u={},c={},f={8:"backspace",9:"tab",13:"enter",16:"shift",17:"ctrl",18:"alt",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"insert",46:"delete",91:"leftwindow",92:"rightwindow",93:"select",144:"numlock",145:"scrolllock",106:"*",107:"+",109:"-",110:".",111:"/",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"},h=0;26>h;h++)f[65+h]=String.fromCharCode(65+h).toLowerCase();for(h=0;10>h;h++)f[48+h]=""+h;for(h=1;20>h;h++)f[111+h]="f"+h;for(h=0;10>h;h++)f[96+h]="numpad"+h;var d={"~":"`","!":"1","@":"2","#":"3",$:"4","%":"5","^":"6","&":"7","*":"8","(":"9",")":"0",_:"-","+":"=",":":";",'"':"'","<":",",">":".","?":"/","|":"\\",plus:"="},l={leftwindow:"meta",select:"meta"},m=["meta","ctrl","alt","shift"];return e.addEventListener("keydown",o),e.addEventListener("keyup",a),e.addEventListener("blur",s),t.bindKey=function(e,n){if("function"!=typeof n){var r=new SyntaxError("Invalid function.");return void t.logError(r,"You must provide a function as the second parameter.")}e=t.isArray(e)?e:[e];for(var o,a=0;o=e[a];a++){var s=i(o);u[s]=n}},t.unbindKey=function(e){e=t.isArray(e)?e:[e];for(var n,r=0;n=e[r];r++){var o=i(n);u[o]=void 0}},t.keyIsPressed=function(t){var e=i(t),n=!0;t=e.split("+");for(var r,o=0;r=t[o];o++)n=n&&!!c[r];return n},t}(kontra||{},window),kontra=function(t){"use strict";function e(e){e=e||{};var n=new e.Object;if("function"!=typeof n.render||"function"!=typeof n.update||"function"!=typeof n.set||"function"!=typeof n.isAlive){var i=new ReferenceError("Required function not found.");return void t.logError(i,"Objects to be pooled must implement render(), update(), set() and isAlive() functions.")}this.size=e.size,this.lastIndex=e.size-1,this.objects=[],this.objects[0]=n;for(var r=1;r<this.size;r++)this.objects[r]=new e.Object}return t.Pool=e,e.prototype.get=function(t){if(this.objects[0].isAlive())return!1;for(var e=this.objects[0],n=1;n<this.size;n++)this.objects[n-1]=this.objects[n];return e.set(t),this.objects[this.lastIndex]=e,!0},e.prototype.update=function(){for(var t,e=this.lastIndex;t=this.objects[e];){if(!t.isAlive())return;if(t.update(),t.isAlive())e--;else{for(var n=e;n>0;n--)this.objects[n]=this.objects[n-1];this.objects[0]=t}}},e.prototype.render=function(){for(var t,e=this.lastIndex;t=this.objects[e];e--){if(!t.isAlive())return;t.render()}},t}(kontra||{}),kontra=function(t,e){"use strict";function n(t,e){this.set(t,e)}function i(e){this.position=new t.Vector,this.velocity=new t.Vector,this.acceleration=new t.Vector,this.timeToLive=0,this.context=t.context,e&&this.set(e)}return t.Vector=n,t.Sprite=i,n.prototype.set=function(t,e){this.x=t||0,this.y=e||0},n.prototype.add=function(t){this.x+=t.x,this.y+=t.y},n.prototype.length=function(){return e.sqrt(this.x*this.x+this.y*this.y)},n.prototype.angle=function(){return e.atan2(this.y,this.x)},n.prototype.fromAngle=function(t,i){return new n(i*e.cos(t),i*e.sin(t))},i.prototype.advance=function(t){this.velocity.add(this.acceleration*t),this.position.add(this.velocity*t),this.timeToLive--},i.prototype.draw=function(){this.context.drawImage(this.image,this.position.x,this.position.y)},i.prototype.isAlive=function(){return this.timeToLive>0},i.prototype.set=function(e){e=e||{},this.position.set(e.x,e.y),this.velocity.set(e.dx,e.dy),this.acceleration.set(e.ddx,e.ddy),this.timeToLive=e.timeToLive||0,this.context=e.context||this.context,t.isImage(e.image)||t.isCanvas(e.image)?(this.image=e.image,this.width=this.image.width,this.height=this.image.height):this.render=t.noop,e.update&&(this.update=e.update),e.render&&(this.render=e.render)},i.prototype.update=function(t){this.advance(t)},i.prototype.render=function(){this.render()},t}(kontra||{},Math),kontra=function(t,e){"use strict";function n(e){if(e=e||{},this.animations={},!t.isImage(e.image)&&!t.isCanvas(e.image)){var n=new SyntaxError("Invalid image.");return void t.logError(n,"You must provide an Image for the SpriteSheet.")}this.image=e.image,this.frameWidth=e.frameWidth,this.frameHeight=e.frameHeight,this.framesPerRow=this.image.width/this.frameWidth|0}function i(t){var e=[],n=t.split("..");n[0]=parseInt(n[0],10),n[1]=parseInt(n[1],10);var i,r=n[0]<n[1]?1:-1;if(1===r)for(i=n[0];i<=n[1];i++)e.push(i);else for(i=n[0];i>=n[1];i--)e.push(i);return e}function r(n,i){this.animationSequence=i.animationSequence,this.frameSpeed=i.frameSpeed;var r,o,a=0,s=0;this.update=function(){s===this.frameSpeed-1&&(a=++a%this.animationSequence.length),s=++s%this.frameSpeed},this.draw=function(t,e){var i=Math.floor(this.animationSequence[a]/n.framesPerRow),r=Math.floor(this.animationSequence[a]%n.framesPerRow);ctx.drawImage(n.image,r*n.frameWidth,i*n.frameHeight,n.frameWidth,n.frameHeight,t,e,n.frameWidth,n.frameHeight)},this.play=function(){r!==e&&(this.update=r),o!==e&&(this.draw=o),r=o=e},this.stop=function(){r===e&&(r=this.update,this.update=t.noop),o===e&&(o=this.draw,this.draw=t.noop)},this.pause=function(){r===e&&(r=this.update,this.update=t.noop)},this.gotoFrame=function(e){t.isNumber(e)&&e>=0&&e<this.animationSequence.length&&(a=e,s=0)}}return t.SpriteSheet=n,n.prototype.createAnimation=function(n){var o;if(!n||0===Object.keys(n).length)return o=new SyntaxError("No animations found."),void t.logError(o,"You must provide at least one named animation to create an Animation.");var a,s;for(var u in n)if(n.hasOwnProperty(u)){if(a=n[u],s=a.frames,a.frameSpeed=a.frameSpeed||1,a.animationSequence=[],s===e)return o=new SyntaxError("No animation frames found."),void t.logError(o,"Animation "+u+" must provide a frames property.");if(t.isNumber(s))a.animationSequence.push(s);else if(t.isString(s))a.animationSequence=i(s);else if(t.isArray(s))for(var c,f=0;c=s[f];f++)if(t.isString(c)){var h=i(c);a.animationSequence.push.apply(a.animationSequence,h)}else a.animationSequence.push(c);this.animations[u]=new r(this,a)}},n.prototype.getAnimation=function(t){return this.animations[t]},t}(kontra||{}),kontra=function(t,e,n,i){"use strict";return t.canUse=t.canUse||{},t.canUse.localStorage="localStorage"in e&&null!==e.localStorage,t.canUse.localStorage?(t.store={},t.store.set=function(t,e){e===i?this.remove(t):n.setItem(t,JSON.stringify(e))},t.store.get=function(t){var e=n.getItem(t);try{e=JSON.parse(e)}catch(i){}return e},t.store.remove=function(t){n.removeItem(t)},t.store.clear=function(){n.clear()},t):t}(kontra||{},window,window.localStorage),kontra=function(t,e){"use strict";return t.TileEngine=function(n){function i(t){var e=t.image,n=t.firstTile||a.length;e.tileWidth=e.width/o.tileWidth,e.tileHeight=e.height/o.tileHeight,e.firstTile=n,o.images.push(e);for(var i=0,s=e.tileWidth*e.tileHeight;s>i;i++)a[n+i]=e;r()}function r(){for(var t,e,n,i,r,u,f,h=0;f=o.layers[s[h]];h++)for(var d=0,l=f.data.length;l>d;d++)if(t=f.data[d],t&&a[t]){e=a[t],n=d%o.width*o.tileWidth,i=(d/o.width|0)*o.tileHeight;var m=t-e.firstTile;r=m%e.tileWidth*o.tileWidth,u=(m/e.tileWidth|0)*o.tileHeight,c.drawImage(e,r,u,o.tileWidth,o.tileHeight,n,i,o.tileWidth,o.tileHeight)}}n=n||{};var o=this,a=[e],s=[];this.tileWidth=n.tileWidth||32,this.tileHeight=n.tileHeight||32,this.width=n.width||t.canvas.width/this.tileWidth|0,this.height=n.height||t.canvas.height/this.tileHeight|0;var u=document.createElement("canvas"),c=u.getContext("2d");u.width=this.width*this.tileWidth,u.height=this.height*this.tileHeight,this.context=n.context||t.context,this.layers={},this.images=[],this.addImage=function(e){e=e||{},t.isString(e.image)?t.loadImage(e.image,e.name).then(function(t){i({image:t,firstTile:e.firstTile})},function(t){console.error(t)}):(t.isImage(e.image)||t.isCanvas(e.image))&&i({image:e.image,firstTile:e.firstTile})},this.removeImage=function(e){for(var n=t.assets[e],i=n.firstTile,r=n.tileWidth*n.tileHeight;r>=i;i++)a[i]=null;for(var o,s=0;o=this.images[s];s++)n===o&&this.images.splice(s,1)},this.addLayer=function(t){t=t||{},this.layers[t.name]={data:t.data,index:t.index},s.push(t.name),s.sort(function(t,e){return o.layers[t].index-o.layers[e].index}),r()},this.removeLayer=function(t){this.layers[t]=null},this.draw=function(){this.context.drawImage(u,0,0)}},t}(kontra||{});