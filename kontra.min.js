this.kontra={init:function(t){var e=this.canvas=document.getElementById(t)||t||document.querySelector("canvas");this.context=e.getContext("2d")},_noop:new Function,_isString:function(t){return""+t===t},_isNumber:function(t){return+t===t},_isImage:function(t){return!!t&&"IMG"===t.nodeName||this._isCanvas(t)},_isCanvas:function(t){return!!t&&"CANVAS"===t.nodeName},_tick:new Function},function(u){var s=/(jpeg|jpg|gif|png)$/,a=/(wav|mp3|ogg|aac)$/,t=/^no$/,e=new Audio,d={wav:"",mp3:e.canPlayType("audio/mpeg;").replace(t,""),ogg:e.canPlayType('audio/ogg; codecs="vorbis"').replace(t,""),aac:e.canPlayType("audio/aac;").replace(t,"")};function f(){for(var t=[],e=0;e<arguments.length;e++)arguments[e]&&t.push(arguments[e].trim().replace(new RegExp("(^[/]{"+(t[0]?1:2)+",}|[/]*$)","g"),""));return t.join("/")}function l(t){return t.split(".").pop()}function p(t){var e=t.replace("."+l(t),"");return 0==e.indexOf("/")&&0==e.lastIndexOf("/")?e.substr(1):e}function o(i){var n=p(i),r=new Image,t=kontra.assets,s=t.images;return i=f(t.imagePath,i),new u(function(t,e){r.onload=function(){s[n]=s[i]=this,t(this)},r.onerror=function(){e(i)},r.src=i})}function h(i){var n,r,s,a,o,t=kontra.assets,h=t.audio,c=t.audioPath;return Array.isArray(i)||(i=[i]),new u(function(t,e){for(o=0;n=i[o];o++)if(d[l(n)]){s=n;break}s?(r=p(s),a=new Audio,n=f(c,s),a.addEventListener("canplay",function(){h[r]=h[n]=this,t(this)}),a.onerror=function(){e(n)},a.src=n,a.load()):e("")})}function c(n){var r=p(n),s=new XMLHttpRequest,t=kontra.assets,a=t.data;return n=f(t.dataPath,n),new u(function(e,i){s.addEventListener("load",function(){var t=s.responseText;if(200!==s.status)return i(t);try{t=JSON.parse(t)}catch(t){}a[r]=a[n]=t,e(t)}),s.open("GET",n,!0),s.send()})}kontra.assets={images:{},audio:{},data:{},imagePath:"",audioPath:"",dataPath:"",load:function(){var t,e,i,n,r=[];for(i=0;e=arguments[i];i++)n=(t=l(Array.isArray(e)?e[0]:e)).match(s)?o(e):t.match(a)?h(e):c(e),r.push(n);return u.all(r)},_canUse:d}}(Promise),function(f,l,p){f.gameLoop=function(t){var e,i,n,r,s=(t=t||{}).fps||60,a=0,o=1e3/s,h=1/s,c=!1===t.clearCanvas?f._noop:function(){f.context.clearRect(0,0,f.canvas.width,f.canvas.height)};function u(){if(i=l(u),n=p.now(),r=n-e,e=n,!(1e3<r)){for(f._tick(),a+=r;o<=a;)d.update(h),a-=o;c(),d.render()}}var d={update:t.update,render:t.render,isStopped:!0,start:function(){e=p.now(),this.isStopped=!1,l(u)},stop:function(){this.isStopped=!0,cancelAnimationFrame(i)},_frame:u,set _last(t){e=t}};return d}}(kontra,requestAnimationFrame,performance),function(){for(var r={},i={},n={8:"backspace",9:"tab",13:"enter",16:"shift",17:"ctrl",18:"alt",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"insert",46:"delete",91:"leftwindow",92:"rightwindow",93:"select",144:"numlock",145:"scrolllock",106:"*",107:"+",109:"-",110:".",111:"/",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"},t=0;t<26;t++)n[65+t]=(10+t).toString(36);for(t=0;t<10;t++)n[48+t]=""+t,n[96+t]="numpad"+t;for(t=1;t<20;t++)n[111+t]="f"+t;var e=window.addEventListener;e("keydown",function(t){var e=n[t.which];i[e]=!0,r[e]&&r[e](t)}),e("keyup",function(t){var e=n[t.which];i[e]=!1}),e("blur",function(t){i={}}),kontra.keys={bind:function(t,e){t=Array.isArray(t)?t:[t];for(var i,n=0;i=t[n];n++)r[i]=e},unbind:function(t){t=Array.isArray(t)?t:[t];for(var e,i=0;e=t[i];i++)r[e]=null},pressed:function(t){return!!i[t]}}}(),function(a){var o,h,c,u=[],d={onOver:[],onOut:[],onDown:[],onUp:[]},t=window.addEventListener;function e(n,r,s){var a;return function(){var t=this,e=arguments,i=s&&!a;clearTimeout(a),a=setTimeout(function(){a=null,s||n.apply(t,e)},r),i&&n.apply(t,e)}}function i(t){n(t,"onDown")}function n(t,e){if(t.target===a.canvas){-1!==t.type.indexOf("mouse")?(o=5,h=t.clientX,c=t.clientY):(o=10,h=t.touches[0].clientX,c=t.touches[0].clientY);var i={clientX:h,clientY:c,type:t.type,x:h-a.canvas.offsetLeft-o/2,y:c-a.canvas.offsetTop-o/2,size:o},n=[];if(d[e].forEach(function(t){(t.collisionFn||f)(i,t.sprite)&&t.sprite.isAlive&&n.push(t)}),1===n.length)n[0].callback(i);else if(1<n.length){var r,s=-1/0;n.forEach(function(t,e){var i=u.indexOf(t.sprite);s<i&&(s=i,r=e)}),n[r].callback(i)}}}function f(t,e){return t.x<e.x+e.width&&t.x+t.size>e.x&&t.y<e.y+e.height&&t.y+t.size>e.y}t("mousedown",i),t("touchstart",i),t("mousemove",e(function(t){n(t,"onOver")},50)),t("mousemove",e(pointerOutHandler,50)),a.pointer={},["onOver","onOut","onDown","onUp"].forEach(function(n){a.pointer[n]=function(t,e,i){d[n].push({sprite:t,callback:e,collisionFn:i}),t._render||(t._render=t.render,t.render=function(){u.push(this),this._render()})}}),a._tick=function(){u.length=0}}(kontra),kontra.pool=function(t){var s=0,a=0;return{create:(t=t||{}).create,objects:[void 0],size:1,maxSize:t.maxSize||1/0,get:function(t){if(t=t||{},this.objects[0].isAlive()){if(this.size===this.maxSize)return;for(var e=0;e<this.size&&this.objects.length<this.maxSize;e++)this.objects.unshift(this.create());this.size=this.objects.length,s=this.size-1}var i=this.objects[0];i.init(t);for(var n=1;n<this.size;n++)this.objects[n-1]=this.objects[n];this.objects[s]=i,a++},getAliveObjects:function(){return this.objects.slice(this.objects.length-a)},clear:function(){a=s=this.objects.length=0,this.size=1,this.objects.push(this.create())},update:function(t){for(var e,i=s,n=Math.max(this.objects.length-a,0);n<=i;)if((e=this.objects[i]).update(t),e.isAlive())i--;else{for(var r=i;0<r;r--)this.objects[r]=this.objects[r-1];this.objects[0]=e,a--,n++}},render:function(){for(var t=Math.max(this.objects.length-a,0),e=s;t<=e;e--)this.objects[e].render&&this.objects[e].render()}}},function(n){n.quadtree=function(t){var e=Object.create(n.quadtree.prototype);return e._init(t),e},n.quadtree.prototype={_init:function(t){t=t||{},this.maxDepth=t.maxDepth||3,this.maxObjects=t.maxObjects||25,this._branch=!1,this._depth=t.depth||0,this._parent=t.parent,this.bounds=t.bounds||{x:0,y:0,width:n.canvas.width,height:n.canvas.height},this.objects=[],this.subnodes=[]},clear:function(){if(this._branch)for(var t=0;t<4;t++)this.subnodes[t].clear();this._branch=!1,this.objects.length=0},get:function(t){for(var e,i,n=[];this.subnodes.length&&this._branch;){for(e=this._getIndex(t),i=0;i<e.length;i++)n.push.apply(n,this.subnodes[e[i]].get(t));return n}return this.objects},add:function(){var t,e,i,n;for(e=0;e<arguments.length;e++)if(i=arguments[e],Array.isArray(i))this.add.apply(this,i);else if(this.subnodes.length&&this._branch)this._add2Sub(i);else if(this.objects.push(i),this.objects.length>this.maxObjects&&this._depth<this.maxDepth){for(this._split(),t=0;n=this.objects[t];t++)this._add2Sub(n);this.objects.length=0}},_add2Sub:function(t){var e,i=this._getIndex(t);for(e=0;e<i.length;e++)this.subnodes[i[e]].add(t)},_getIndex:function(t){var e=[],i=this.bounds.x+this.bounds.width/2,n=this.bounds.y+this.bounds.height/2,r=t.y<n&&t.y+t.height>=this.bounds.y,s=t.y+t.height>=n&&t.y<this.bounds.y+this.bounds.height;return t.x<i&&t.x+t.width>=this.bounds.x&&(r&&e.push(0),s&&e.push(2)),t.x+t.width>=i&&t.x<this.bounds.x+this.bounds.width&&(r&&e.push(1),s&&e.push(3)),e},_split:function(){if(this._branch=!0,!this.subnodes.length)for(var t=this.bounds.width/2|0,e=this.bounds.height/2|0,i=0;i<4;i++)this.subnodes[i]=n.quadtree({bounds:{x:this.bounds.x+(i%2==1?t:0),y:this.bounds.y+(2<=i?e:0),width:t,height:e},depth:this._depth+1,maxDepth:this.maxDepth,maxObjects:this.maxObjects,parent:this})}}}(kontra),function(o,e,r){o.vector=function(t,e){var i=Object.create(o.vector.prototype);return i._init(t,e),i},o.vector.prototype={_init:function(t,e){this._x=t||0,this._y=e||0},add:function(t,e){this._x+=(t.x||0)*(e||1),this._y+=(t.y||0)*(e||1)},clamp:function(t,e,i,n){this._clamp=!0,this._xMin=void 0!==t?t:-r,this._yMin=void 0!==e?e:-r,this._xMax=void 0!==i?i:r,this._yMax=void 0!==n?n:r},get x(){return this._x},get y(){return this._y},set x(t){this._x=this._clamp?e.min(e.max(this._xMin,t),this._xMax):t},set y(t){this._y=this._clamp?e.min(e.max(this._yMin,t),this._yMax):t}},o.sprite=function(t){var e=Object.create(o.sprite.prototype);return e.init(t),e},o.sprite.prototype={init:function(t){var e,i,n,r=this;for(var s in t=t||{},r.position=r.position||o.vector(),r.velocity=r.velocity||o.vector(),r.acceleration=r.acceleration||o.vector(),r.position._init(t.x,t.y),r.velocity._init(t.dx,t.dy),r.acceleration._init(t.ddx,t.ddy),r.width=r.height=0,t)r[s]=t[s];if(r.ttl=t.ttl||0,r.context=t.context||o.context,r.advance=r._advance,r.draw=r._draw,o._isImage(e=t.image))r.image=e,r.width=e.width,r.height=e.height,r.draw=r._drawImg;else if(e=t.animations){for(var a in r.animations={},e)i=e[a],r.animations[a]=i.clone?i.clone():i,n||(n=r.animations[a]);r.currentAnimation=n,r.width=n.width,r.height=n.height,r.advance=r._advanceAnim,r.draw=r._drawAnim}},get x(){return this.position.x},get y(){return this.position.y},get dx(){return this.velocity.x},get dy(){return this.velocity.y},get ddx(){return this.acceleration.x},get ddy(){return this.acceleration.y},set x(t){this.position.x=t},set y(t){this.position.y=t},set dx(t){this.velocity.x=t},set dy(t){this.velocity.y=t},set ddx(t){this.acceleration.x=t},set ddy(t){this.acceleration.y=t},isAlive:function(){return 0<this.ttl},collidesWith:function(t){return this.x<t.x+t.width&&this.x+this.width>t.x&&this.y<t.y+t.height&&this.y+this.height>t.y},update:function(t){this.advance(t)},render:function(){this.draw()},playAnimation:function(t){this.currentAnimation=this.animations[t]},_advance:function(t){this.velocity.add(this.acceleration,t),this.position.add(this.velocity,t),this.ttl--},_advanceAnim:function(t){this._advance(t),this.currentAnimation.update(t)},_draw:function(){this.context.fillStyle=this.color,this.context.fillRect(this.x,this.y,this.width,this.height)},_drawImg:function(){this.context.drawImage(this.image,this.x,this.y)},_drawAnim:function(){this.currentAnimation.render({context:this.context,x:this.x,y:this.y})}}}(kontra,Math,1/0),function(h){h.animation=function(t){var e=Object.create(h.animation.prototype);return e._init(t),e},h.animation.prototype={_init:function(t){t=t||{},this.spriteSheet=t.spriteSheet,this.frames=t.frames,this.frameRate=t.frameRate;var e=t.spriteSheet.frame;this.width=e.width,this.height=e.height,this.margin=e.margin||0,this._frame=0,this._accum=0},clone:function(){return h.animation(this)},update:function(t){for(t=t||1/60,this._accum+=t;1<=this._accum*this.frameRate;)this._frame=++this._frame%this.frames.length,this._accum-=1/this.frameRate},render:function(t){var e=(t=t||{}).context||h.context,i=this.frames[this._frame]/this.spriteSheet.framesPerRow|0,n=this.frames[this._frame]%this.spriteSheet.framesPerRow|0;e.drawImage(this.spriteSheet.image,n*this.width+(2*n+1)*this.margin,i*this.height+(2*i+1)*this.margin,this.width,this.height,t.x,t.y,this.width,this.height)}},h.spriteSheet=function(t){var e=Object.create(h.spriteSheet.prototype);return e._init(t),e},h.spriteSheet.prototype={_init:function(t){t=t||{},this.animations={},this.image=t.image,this.frame={width:t.frameWidth,height:t.frameHeight,margin:t.frameMargin},this.framesPerRow=t.image.width/t.frameWidth|0,this.createAnimations(t.animations)},createAnimations:function(t){var e,i,n,r;for(var s in t){i=(e=t[s]).frames,n=e.frameRate,r=[],Array.isArray(i)||(i=[i]);for(var a,o=0;a=i[o];o++)r.push.apply(r,this._parse(a));this.animations[s]=h.animation({spriteSheet:this,frames:r,frameRate:n})}},_parse:function(t){if(h._isNumber(t))return[t];var e=[],n=t.split(".."),r=i=+n[0],s=+n[1];if(r<s)for(;i<=s;i++)e.push(i);else for(;i>=s;i--)e.push(i);return e}}}(kontra),kontra.store={set:function(t,e){void 0===e?localStorage.removeItem(t):localStorage.setItem(t,JSON.stringify(e))},get:function(t){var e=localStorage.getItem(t);try{e=JSON.parse(e)}catch(t){}return e}},function(d,I,f){d.tileEngine=function(t){function x(t){var e,i;return void 0!==t.x&&void 0!==t.y?(e=O.getRow(t.y),i=O.getCol(t.x)):(e=t.row,i=t.col),e<0||i<0||b<=e||_<=i?-1:i+e*_}function w(t){for(var e,i,n=0,r=O.tilesets.length-1;n<=r;){if(e=(n+r)/2|0,t>=(i=O.tilesets[e]).firstGrid&&t<=i.lastGrid)return i;i.lastGrid<t?n=e+1:r=e-1}}var e,i,_=(t=t||{}).width,b=t.height,j=t.tileWidth||t.tilewidth||32,A=t.tileHeight||t.tileheight||32,n=_*j,r=b*A,s=t.context||d.context,S=s.canvas.width,k=s.canvas.height,a=document.createElement("canvas"),l=a.getContext("2d"),o=I.max(0,n-S),h=I.max(0,r-k),p=[],O={width:_,height:b,tileWidth:j,tileHeight:A,mapWidth:n,mapHeight:r,context:s,x:t.x||0,y:t.y||0,tilesets:[],layers:{},addTilesets:function(t){f.isArray(t)||(t=[t]),t.forEach(function(t){var e,i,n,r,s,a=t.image;if(d._isImage(a))e=a;else if(d._isString(a))for(var o=1/0;0<=o;){var h=(o=a.lastIndexOf("/",o))<0?a:a.substr(o);if(d.assets.images[h]){e=d.assets.images[h];break}o--}i=t.firstGrid,n=(e.width/j|0||1)*(e.height/A|0||1),i||(0<O.tilesets.length?(s=((r=O.tilesets[O.tilesets.length-1]).image.width/j|0)*(r.image.height/A|0),i=r.firstGrid+s):i=1),O.tilesets.push({firstGrid:i,lastGrid:i+n-1,image:e}),O.tilesets.sort(function(t,e){return t.firstGrid-e.firstGrid})})},addLayers:function(t){f.isArray(t)||(t=[t]),t.forEach(function(t){var e,i,n,r,s,a;if(t.render=void 0===t.render||t.render,f.isArray(t.data[0]))for(e=[],i=0;n=t.data[i];i++)for(r=0;r<_;r++)e.push(n[r]||0);else e=t.data;for(s in O.layers[t.name]={data:e,zIndex:t.zIndex||0,render:t.render},t.properties){a=t.properties[s];try{a=JSON.parse(a)}catch(t){}O.layers[t.name][s]=a}O.layers[t.name].render&&(p.push(t.name),p.sort(function(t,e){return O.layers[t].zIndex-O.layers[e].zIndex}))}),function(){for(var t,e,i,n,r,s,a,o,h,c,u=0;c=O.layers[p[u]];u++)for(var d=0,f=c.data.length;d<f;d++)(t=c.data[d])&&(i=(e=w(t)).image,n=d%_*j,r=(d/_|0)*A,s=(o=t-e.firstGrid)%(h=i.width/j)*j,a=(o/h|0)*A,l.drawImage(i,s,a,j,A,n,r,j,A))}()},layerCollidesWith:function(t,e){for(var i,n=O.getRow(e.y),r=O.getCol(e.x),s=O.getRow(e.y+e.height),a=O.getCol(e.x+e.width),o=n;o<=s;o++)for(var h=r;h<=a;h++)if(i=x({row:o,col:h}),O.layers[t].data[i])return!0;return!1},tileAtLayer:function(t,e){var i=x(e);if(0<=i)return O.layers[t].data[i]},render:function(){O.context.drawImage(a,O.sx,O.sy,S,k,O.x,O.y,S,k)},renderLayer:function(t){for(var e,i,n,r,s,a,o,h,c,u=O.layers[t],d=O.getRow(),f=O.getCol(),l=x({row:d,col:f}),p=f*j-O.sx,m=d*A-O.sy,g=I.min(I.ceil(S/j)+1,_),y=g*I.min(I.ceil(k/A)+1,b),v=0;v<y;)(n=u.data[l])&&(s=(r=w(n)).image,e=p+v%g*j,i=m+(v/g|0)*A,h=(a=n-r.firstGrid)%(o=s.width/j)*j,c=(a/o|0)*A,O.context.drawImage(s,h,c,j,A,e,i,j,A)),++v%g==0?l=f+ ++d*_:l++},getRow:function(t){return t=t||0,(O.sy+t)/A|0},getCol:function(t){return t=t||0,(O.sx+t)/j|0},get sx(){return e},get sy(){return i},set sx(t){e=I.min(I.max(0,t),o)},set sy(t){i=I.min(I.max(0,t),h)},_layerOrder:p};for(var c in O.sx=t.sx||0,O.sy=t.sy||0,a.width=n,a.height=r,t.properties){var u=t.properties[c];try{u=JSON.parse(u)}catch(t){}O[c]=O[c]||u}return t.tilesets&&O.addTilesets(t.tilesets),t.layers&&O.addLayers(t.layers),O}}(kontra,Math,Array);