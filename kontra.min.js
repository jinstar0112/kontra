this.kontra={init:function(t){var i=this.canvas=document.getElementById(t)||t||document.querySelector("canvas");this.context=i.getContext("2d")},_noop:new Function,_tick:new Function},function(){var a=/(jpeg|jpg|gif|png)$/,r=/(wav|mp3|ogg|aac)$/,t=/^no$/,e=/^\//,n=/\/$/,i=new Audio,o={wav:"",mp3:i.canPlayType("audio/mpeg;").replace(t,""),ogg:i.canPlayType('audio/ogg; codecs="vorbis"').replace(t,""),aac:i.canPlayType("audio/aac;").replace(t,"")};function h(t,i){return[t.replace(n,""),i.replace(e,"")].join("/")}function c(t){return t.split(".").pop()}function u(t){var i=t.replace("."+c(t),"");return 2==i.split("/").length?i.replace(e,""):i}function d(n,s){return new Promise(function(t,i){var e=new Image;s=h(p.imagePath,n),e.onload=function(){p.images[u(n)]=p.images[s]=this,t(this)},e.onerror=function(){i(s)},e.src=s})}function f(n,s,a){return new Promise(function(t,i){if(n=[].concat(n).reduce(function(t,i){return o[c(i)]?i:t},a)){var e=new Audio;s=h(p.audioPath,n),e.addEventListener("canplay",function(){p.audio[u(n)]=p.audio[s]=this,t(this)}),e.onerror=function(){i(s)},e.src=s,e.load()}else i(n)})}function l(i,e){return e=h(p.dataPath,i),fetch(e).then(function(t){if(!t.ok)throw t;return t.clone().json().catch(function(){return t.text()})}).then(function(t){return p.data[u(i)]=p.data[e]=t,t})}var p=kontra.assets={images:{},audio:{},data:{},imagePath:"",audioPath:"",dataPath:"",load:function(){var t,i,e,n,s=[];for(e=0;i=arguments[e];e++)n=(t=c([].concat(i)[0])).match(a)?d(i):t.match(r)?f(i):l(i),s.push(n);return Promise.all(s)}}}(),kontra.gameLoop=function(t){var i,e,n,s,a=(t=t||{}).fps||60,r=0,o=1e3/a,h=1/a,c=!1===t.clearCanvas?kontra._noop:function(){kontra.context.clearRect(0,0,kontra.canvas.width,kontra.canvas.height)};function u(){if(e=requestAnimationFrame(u),n=performance.now(),s=n-i,i=n,!(1e3<s)){for(kontra._tick(),r+=s;o<=r;)d.update(h),r-=o;c(),d.render()}}var d={update:t.update,render:t.render,isStopped:!0,start:function(){i=performance.now(),this.isStopped=!1,requestAnimationFrame(u)},stop:function(){this.isStopped=!0,cancelAnimationFrame(e)}};return d},function(){for(var e={},n={},s={13:"enter",27:"esc",32:"space",37:"left",38:"up",39:"right",40:"down"},t=0;t<26;t++)s[65+t]=(10+t).toString(36);for(t=0;t<10;t++)s[48+t]=""+t;addEventListener("keydown",function(t){var i=s[t.which];n[i]=!0,e[i]&&e[i](t)}),addEventListener("keyup",function(t){n[s[t.which]]=!1}),addEventListener("blur",function(t){n={}}),kontra.keys={bind:function(t,i){[].concat(t).map(function(t){e[t]=i})},unbind:function(t,i){[].concat(t).map(function(t){e[t]=i})},pressed:function(t){return!!n[t]}}}(),function(){var o=[],h=[],a={},n=[],i={},e={0:"left",1:"middle",2:"right"};function r(){for(var t,i,e,n,s,a=h.length?h:o,r=a.length-1;0<=r;r--)if((t=a[r]).collidesWithPointer?i=t.collidesWithPointer(u):(e=t,void 0,n=u.x-Math.max(e.x,Math.min(u.x,e.x+e.width)),s=u.y-Math.max(e.y,Math.min(u.y,e.y+e.height)),i=n*n+s*s<u.radius*u.radius),i)return t}function t(t){i[e[t.button]]=!0,c(t,"onDown")}function s(t){i[e[t.button]]=!1,c(t,"onUp")}function c(t,i){var e,n,s;kontra.canvas&&(-1!==t.type.indexOf("mouse")?(e=t.clientX,n=t.clientY):(e=(t.touches[0]||t.changedTouches[0]).clientX,n=(t.touches[0]||t.changedTouches[0]).clientY),u.x=e-kontra.canvas.offsetLeft,u.y=n-kontra.canvas.offsetTop,t.target===kontra.canvas&&(s=r())&&s[i]&&s[i](),a[i]&&a[i](t,s))}addEventListener("mousedown",t),addEventListener("touchstart",t),addEventListener("mouseup",s),addEventListener("touchend",s),addEventListener("blur",function(t){i={}}),addEventListener("mousemove",function(t){c(t,"onOver")});var u=kontra.pointer={x:0,y:0,radius:5,track:function(t){[].concat(t).map(function(t){t._r||(t._r=t.render,t.render=function(){o.push(this),this._r()},n.push(t))})},untrack:function(t,e){[].concat(t).map(function(t){t.render=t._r,t._r=e;var i=n.indexOf(t);-1!==i&&n.splice(i,1)})},over:function(t){return-1!==n.indexOf(t)&&r()===t},onDown:function(t){a.onDown=t},onUp:function(t){a.onUp=t},pressed:function(t){return!!i[t]}};kontra._tick=function(){h.length=0,o.map(function(t){h.push(t)}),o.length=0}}(),kontra.pool=function(t){var s=0;return{_c:(t=t||{}).create,objects:[t.create()],size:1,maxSize:t.maxSize||1/0,get:function(t){if(t=t||{},this.objects[0].isAlive()){if(this.size===this.maxSize)return;for(var i=0;i<this.size&&this.objects.length<this.maxSize;i++)this.objects.unshift(this._c());this.size=this.objects.length}var e=this.objects.shift();e.init(t),this.objects.push(e),s++},getAliveObjects:function(){return this.objects.slice(this.objects.length-s)},clear:function(){s=this.objects.length=0,this.size=1,this.objects.push(this._c())},update:function(t){for(var i,e=this.size-1,n=Math.max(this.objects.length-s,0);n<=e;)(i=this.objects[e]).update(t),i.isAlive()?e--:(this.objects=this.objects.splice(e,1).concat(this.objects),s--,n++)},render:function(){for(var t=Math.max(this.objects.length-s,0),i=this.size-1;t<=i;i--)this.objects[i].render()}}},kontra.quadtree=function(t){var i=Object.create(kontra.quadtree.prototype);return i._i(t),i},kontra.quadtree.prototype={_i:function(t){t=t||{},this.maxDepth=t.maxDepth||3,this.maxObjects=t.maxObjects||25,this._b=!1,this._d=t.depth||0,this.bounds=t.bounds||{x:0,y:0,width:kontra.canvas.width,height:kontra.canvas.height},this.objects=[],this.subnodes=[]},clear:function(){this.subnodes.map(function(t){t.clear()}),this._b=!1,this.objects.length=0},get:function(t){for(var i,e,n=[];this.subnodes.length&&this._b;){for(i=this._g(t),e=0;e<i.length;e++)n.push.apply(n,this.subnodes[i[e]].get(t));return n}return this.objects},add:function(){var t,i,e,n;for(i=0;i<arguments.length;i++)if(e=arguments[i],Array.isArray(e))this.add.apply(this,e);else if(this._b)this._a(e);else if(this.objects.push(e),this.objects.length>this.maxObjects&&this._d<this.maxDepth){for(this._s(),t=0;n=this.objects[t];t++)this._a(n);this.objects.length=0}},_a:function(t){var i,e=this._g(t);for(i=0;i<e.length;i++)this.subnodes[e[i]].add(t)},_g:function(t){var i=[],e=this.bounds.x+this.bounds.width/2,n=this.bounds.y+this.bounds.height/2,s=t.y<n&&t.y+t.height>=this.bounds.y,a=t.y+t.height>=n&&t.y<this.bounds.y+this.bounds.height;return t.x<e&&t.x+t.width>=this.bounds.x&&(s&&i.push(0),a&&i.push(2)),t.x+t.width>=e&&t.x<this.bounds.x+this.bounds.width&&(s&&i.push(1),a&&i.push(3)),i},_s:function(){if(this._b=!0,!this.subnodes.length)for(var t=this.bounds.width/2|0,i=this.bounds.height/2|0,e=0;e<4;e++)this.subnodes[e]=kontra.quadtree({bounds:{x:this.bounds.x+(e%2==1?t:0),y:this.bounds.y+(2<=e?i:0),width:t,height:i},depth:this._d+1,maxDepth:this.maxDepth,maxObjects:this.maxObjects})}},kontra.vector=function(t,i){var e=Object.create(kontra.vector.prototype);return e._init(t,i),e},kontra.vector.prototype={_init:function(t,i){this._x=t||0,this._y=i||0},add:function(t,i){this.x+=(t.x||0)*(i||1),this.y+=(t.y||0)*(i||1)},clamp:function(t,i,e,n){this._c=!0,this._a=t,this._b=i,this._d=e,this._e=n},get x(){return this._x},get y(){return this._y},set x(t){this._x=this._c?Math.min(Math.max(this._a,t),this._d):t},set y(t){this._y=this._c?Math.min(Math.max(this._b,t),this._e):t}},kontra.sprite=function(t,i){return(i=Object.create(kontra.sprite.prototype)).init(t),i},kontra.sprite.prototype={init:function(t,i,e,n){for(i in t=t||{},this.position=kontra.vector(t.x,t.y),this.velocity=kontra.vector(t.dx,t.dy),this.acceleration=kontra.vector(t.ddx,t.ddy),this.width=this.height=0,this.context=kontra.context,this.advance=this._a,this.draw=this._c,t)this[i]=t[i];if(e=t.image)this.image=e,this.width=e.width,this.height=e.height,this.draw=this._d;else if(e=t.animations){for(i in e)this.animations[i]=e[i].clone(),n=n||e[i];this._ca=n,this.width=n.width,this.height=n.height,this.advance=this._b,this.draw=this._e}},get x(){return this.position.x},get y(){return this.position.y},get dx(){return this.velocity.x},get dy(){return this.velocity.y},get ddx(){return this.acceleration.x},get ddy(){return this.acceleration.y},set x(t){this.position.x=t},set y(t){this.position.y=t},set dx(t){this.velocity.x=t},set dy(t){this.velocity.y=t},set ddx(t){this.acceleration.x=t},set ddy(t){this.acceleration.y=t},isAlive:function(){return 0<this.ttl},collidesWith:function(t){return this.x<t.x+t.width&&this.x+this.width>t.x&&this.y<t.y+t.height&&this.y+this.height>t.y},update:function(t){this.advance(t)},render:function(){this.draw()},playAnimation:function(t){this._ca=this.animations[t],this._ca.loop||this._ca.reset()},_a:function(t){this.velocity.add(this.acceleration,t),this.position.add(this.velocity,t),this.ttl--},_b:function(t){this._a(t),this._ca.update(t)},_c:function(){this.context.fillStyle=this.color,this.context.fillRect(this.x,this.y,this.width,this.height)},_d:function(){this.context.drawImage(this.image,this.x,this.y)},_e:function(){this._ca.render(this)}},kontra.animation=function(t){var i=Object.create(kontra.animation.prototype);return i._i(t),i},kontra.animation.prototype={_i:function(t,i){t=t||{},this.spriteSheet=t.spriteSheet,this.frames=t.frames,this.frameRate=t.frameRate,this.loop=void 0===t.loop||t.loop,i=t.spriteSheet.frame,this.width=i.width,this.height=i.height,this.margin=i.margin||0,this._f=0,this._a=0},clone:function(){return kontra.animation(this)},reset:function(){this._f=0,this._a=0},update:function(t){if(this.loop||this._f!=this.frames.length-1)for(t=t||1/60,this._a+=t;1<=this._a*this.frameRate;)this._f=++this._f%this.frames.length,this._a-=1/this.frameRate},render:function(t){var i=(t=t||{}).context||kontra.context,e=this.frames[this._f]/this.spriteSheet._f|0,n=this.frames[this._f]%this.spriteSheet._f|0;i.drawImage(this.spriteSheet.image,n*this.width+(2*n+1)*this.margin,e*this.height+(2*e+1)*this.margin,this.width,this.height,t.x,t.y,this.width,this.height)}},kontra.spriteSheet=function(t){var i=Object.create(kontra.spriteSheet.prototype);return i._i(t),i},kontra.spriteSheet.prototype={_i:function(t){t=t||{},this.animations={},this.image=t.image,this.frame={width:t.frameWidth,height:t.frameHeight,margin:t.frameMargin},this._f=t.image.width/t.frameWidth|0,this.createAnimations(t.animations)},createAnimations:function(t){var i,e,n,s;for(s in t)e=(i=t[s]).frames,n=[],[].concat(e).map(function(t){n=n.concat(this._p(t))},this),this.animations[s]=kontra.animation({spriteSheet:this,frames:n,frameRate:i.frameRate,loop:i.loop})},_p:function(t){if(+t===t)return t;var e=[],n=t.split(".."),s=i=+n[0],a=+n[1];if(s<a)for(;i<=a;i++)e.push(i);else for(;i>=a;i--)e.push(i);return e}},kontra.store={set:function(t,i){void 0===i?localStorage.removeItem(t):localStorage.setItem(t,JSON.stringify(i))},get:function(t){var i=localStorage.getItem(t);try{i=JSON.parse(i)}catch(t){}return i}},kontra.tileEngine=function(t){function v(t){var i,e;return void 0!==t.x&&void 0!==t.y?(i=O.getRow(t.y),e=O.getCol(t.x)):(i=t.row,e=t.col),i<0||e<0||w<=i||b<=e?-1:e+i*b}function _(t){for(var i,e,n=0,s=O.tilesets.length-1;n<=s;){if(i=(n+s)/2|0,t>=(e=O.tilesets[i]).firstGrid&&t<=e.lastGrid)return e;e.lastGrid<t?n=i+1:s=i-1}}var i,e,b=(t=t||{}).width,w=t.height,k=t.tileWidth||t.tilewidth||32,j=t.tileHeight||t.tileheight||32,n=b*k,s=w*j,a=t.context||kontra.context,S=a.canvas.width,M=a.canvas.height,r=document.createElement("canvas"),l=r.getContext("2d"),o=Math.max(0,n-S),h=Math.max(0,s-M),p=[],O={width:b,height:w,tileWidth:k,tileHeight:j,mapWidth:n,mapHeight:s,context:a,x:t.x||0,y:t.y||0,tilesets:[],layers:{},addTilesets:function(t){[].concat(t).map(function(t){var i,e,n,s,a,r=t.image;if(""+r===r)for(var o=1/0;0<=o;){var h=(o=r.lastIndexOf("/",o))<0?r:r.substr(o);if(kontra.assets.images[h]){i=kontra.assets.images[h];break}o--}else i=r;e=t.firstGrid,n=(i.width/k|0||1)*(i.height/j|0||1),e||(0<O.tilesets.length?(a=((s=O.tilesets[O.tilesets.length-1]).image.width/k|0)*(s.image.height/j|0),e=s.firstGrid+a):e=1),O.tilesets.push({firstGrid:e,lastGrid:e+n-1,image:i}),O.tilesets.sort(function(t,i){return t.firstGrid-i.firstGrid})})},addLayers:function(t){[].concat(t).map(function(t){var i,e,n,s,a,r;if(t.render=void 0===t.render||t.render,Array.isArray(t.data[0]))for(i=[],e=0;n=t.data[e];e++)for(s=0;s<b;s++)i.push(n[s]||0);else i=t.data;for(a in O.layers[t.name]={data:i,zIndex:t.zIndex||0,render:t.render},t.properties){r=t.properties[a];try{r=JSON.parse(r)}catch(t){}O.layers[t.name][a]=r}O.layers[t.name].render&&(p.push(t.name),p.sort(function(t,i){return O.layers[t].zIndex-O.layers[i].zIndex}))}),function(){for(var t,i,e,n,s,a,r,o,h,c,u=0;c=O.layers[p[u]];u++)for(var d=0,f=c.data.length;d<f;d++)(t=c.data[d])&&(e=(i=_(t)).image,n=d%b*k,s=(d/b|0)*j,a=(o=t-i.firstGrid)%(h=e.width/k)*k,r=(o/h|0)*j,l.drawImage(e,a,r,k,j,n,s,k,j))}()},layerCollidesWith:function(t,i){for(var e,n=O.getRow(i.y),s=O.getCol(i.x),a=O.getRow(i.y+i.height),r=O.getCol(i.x+i.width),o=n;o<=a;o++)for(var h=s;h<=r;h++)if(e=v({row:o,col:h}),O.layers[t].data[e])return!0;return!1},tileAtLayer:function(t,i){var e=v(i);if(0<=e)return O.layers[t].data[e]},render:function(){O.context.drawImage(r,O.sx,O.sy,S,M,O.x,O.y,S,M)},renderLayer:function(t){for(var i,e,n,s,a,r,o,h,c,u=O.layers[t],d=O.getRow(),f=O.getCol(),l=v({row:d,col:f}),p=f*k-O.sx,g=d*j-O.sy,m=Math.min(Math.ceil(S/k)+1,b),y=m*Math.min(Math.ceil(M/j)+1,w),x=0;x<y;)(n=u.data[l])&&(a=(s=_(n)).image,i=p+x%m*k,e=g+(x/m|0)*j,h=(r=n-s.firstGrid)%(o=a.width/k)*k,c=(r/o|0)*j,O.context.drawImage(a,h,c,k,j,i,e,k,j)),++x%m==0?l=f+ ++d*b:l++},getRow:function(t){return t=t||0,(O.sy+t)/j|0},getCol:function(t){return t=t||0,(O.sx+t)/k|0},get sx(){return i},get sy(){return e},set sx(t){i=Math.min(Math.max(0,t),o)},set sy(t){e=Math.min(Math.max(0,t),h)}};for(var c in O.sx=t.sx||0,O.sy=t.sy||0,r.width=n,r.height=s,t.properties){var u=t.properties[c];try{u=JSON.parse(u)}catch(t){}O[c]=O[c]||u}return t.tilesets&&O.addTilesets(t.tilesets),t.layers&&O.addLayers(t.layers),O};