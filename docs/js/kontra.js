var kontra=function(){"use strict";const t={},e={init(t){let e=this.canvas=document.getElementById(t)||t||document.querySelector("canvas");this.context=e.getContext("2d"),this.context.imageSmoothingEnabled=!1,this.emit("init",this)},on(e,i){t[e]=t[e]||[],t[e].push(i)},off(e,i,s){!t[e]||(s=t[e].indexOf(i))<0||t[e].splice(s,1)},emit(e,...i){t[e]&&t[e].forEach(t=>t(...i))},_noop:new Function};class i{constructor(t,e){t=t||{},this.spriteSheet=t.spriteSheet,this.frames=t.frames,this.frameRate=t.frameRate,this.loop=void 0===t.loop||t.loop,e=t.spriteSheet.frame,this.width=e.width,this.height=e.height,this.margin=e.margin||0,this._f=0,this._a=0}clone(){return s(this)}reset(){this._f=0,this._a=0}update(t){if(this.loop||this._f!=this.frames.length-1)for(t=t||1/60,this._a+=t;this._a*this.frameRate>=1;)this._f=++this._f%this.frames.length,this._a-=1/this.frameRate}render(t){t=t||{};let i=this.frames[this._f]/this.spriteSheet._f|0,s=this.frames[this._f]%this.spriteSheet._f|0,n=void 0!==t.width?t.width:this.width,h=void 0!==t.height?t.height:this.height;(t.context||e.context).drawImage(this.spriteSheet.image,s*this.width+(2*s+1)*this.margin,i*this.height+(2*i+1)*this.margin,this.width,this.height,t.x,t.y,n,h)}}function s(t){return new i(t)}s.prototype=i.prototype;let n,h=/(jpeg|jpg|gif|png)$/,o=/(wav|mp3|ogg|aac)$/,a=/^no$/,r=/^\//,c=/\/$/,d=new WeakMap,u=new Audio,l={wav:"",mp3:u.canPlayType("audio/mpeg;").replace(a,""),ogg:u.canPlayType('audio/ogg; codecs="vorbis"').replace(a,""),aac:u.canPlayType("audio/aac;").replace(a,"")};function f(t,e){return[t.replace(c,""),t?e.replace(r,""):e].filter(t=>t).join("/")}function g(t){return t.split(".").pop()}function p(t){let e=t.replace("."+g(t),"");return 2==e.split("/").length?e.replace(r,""):e}function m(t,e){return new URL(t,e).href}function y(t,e){return new Promise(function(i,s){let h=new Image;e=f(n.imagePath,t),h.onload=function(){let s=m(e,window.location.href);n.images[p(t)]=n.images[e]=n.images[s]=this,i(this)},h.onerror=function(){s(e)},h.src=e})}function x(t,e,i){return new Promise(function(s,h){if(t=[].concat(t).reduce(function(t,e){return l[g(e)]?e:t},i)){let i=new Audio;e=f(n.audioPath,t),i.addEventListener("canplay",function(){let i=m(e,window.location.href);n.audio[p(t)]=n.audio[e]=n.audio[i]=this,s(this)}),i.onerror=function(){h(e)},i.src=e,i.load()}else h(t)})}function w(t,e){return e=f(n.dataPath,t),fetch(e).then(function(t){if(!t.ok)throw t;return t.clone().json().catch(function(){return t.text()})}).then(function(i){let s=m(e,window.location.href);return"object"==typeof i&&d.set(i,s),n.data[p(t)]=n.data[e]=n.data[s]=i,i})}var _=n={images:{},audio:{},data:{},imagePath:"",audioPath:"",dataPath:"",_d:d,_u:m,load(){let t,e,i,s,n,a=[];for(s=0;i=arguments[s];s++)n=(e=g(t=[].concat(i)[0])).match(h)?y(i):e.match(o)?x(i):w(i),a.push(n);return Promise.all(a)}};let b,v={},j={},A={13:"enter",27:"esc",32:"space",37:"left",38:"up",39:"right",40:"down"};for(b=0;b<26;b++)A[65+b]=(10+b).toString(36);for(b=0;b<10;b++)A[48+b]=""+b;addEventListener("keydown",function(t){let e=A[t.which];j[e]=!0,v[e]&&v[e](t)}),addEventListener("keyup",function(t){j[A[t.which]]=!1}),addEventListener("blur",function(t){j={}});const E={map:A,bind(t,e){[].concat(t).map(function(t){v[t]=e})},unbind(t,e){[].concat(t).map(function(t){v[t]=e})},pressed:t=>!!j[t]};let S=Object.getOwnPropertyNames;function O(t){let e=t.substr(t.search(/[A-Z]/));return e[0].toLowerCase()+e.substr(1)}function L(t,e){let i=t.indexOf(e);-1!==i&&t.splice(i,1)}function M(t){return e[t]?e[t].prototype||e[t]:null}const P={register(t,e){const i=M(t);i&&(i._inc||(i._inc={},i._bInc=function(t,e,...i){return this._inc[e].before.reduce((e,i)=>{let s=i(t,...e);return s||e},i)},i._aInc=function(t,e,i,...s){return this._inc[e].after.reduce((e,i)=>{let n=i(t,e,...s);return n||e},i)}),S(e).forEach(t=>{let s=O(t);i[s]&&(i["_o"+s]||(i["_o"+s]=i[s],i[s]=function(...t){let e=this._bInc(this,s,...t),n=i["_o"+s].call(this,...e);return this._aInc(this,s,n,...t)}),i._inc[s]||(i._inc[s]={before:[],after:[]}),t.startsWith("before")?i._inc[s].before.push(e[t]):t.startsWith("after")&&i._inc[s].after.push(e[t]))}))},unregister(t,e){const i=M(t);i&&i._inc&&S(e).forEach(t=>{let s=O(t);t.startsWith("before")?L(i._inc[s].before,e[t]):t.startsWith("after")&&L(i._inc[s].after,e[t])})},extend(t,e){const i=M(t);i&&S(e).forEach(t=>{i[t]||(i[t]=e[t])})}};let I,k=[],z=[],W={},R=[],D={},C={0:"left",1:"middle",2:"right"};function T(t){let e=t.x,i=t.y;t.anchor&&(e-=t.width*t.anchor.x,i-=t.height*t.anchor.y);let s=I.x-Math.max(e,Math.min(I.x,e+t.width)),n=I.y-Math.max(i,Math.min(I.y,i+t.height));return s*s+n*n<I.radius*I.radius}function q(){let t,e,i=z.length?z:k;for(let s=i.length-1;s>=0;s--)if(e=(t=i[s]).collidesWithPointer?t.collidesWithPointer(I):T(t))return t}function F(t){let e=void 0!==t.button?C[t.button]:"left";D[e]=!0,B(t,"onDown")}function U(t){let e=void 0!==t.button?C[t.button]:"left";D[e]=!1,B(t,"onUp")}function $(t){B(t,"onOver")}function N(t){D={}}function B(t,i){if(!e.canvas)return;let s,n;-1!==["touchstart","touchmove","touchend"].indexOf(t.type)?(s=(t.touches[0]||t.changedTouches[0]).clientX,n=(t.touches[0]||t.changedTouches[0]).clientY):(s=t.clientX,n=t.clientY);let h,o=e.canvas.height/e.canvas.offsetHeight,a=e.canvas.getBoundingClientRect(),r=(s-a.left)*o,c=(n-a.top)*o;I.x=r,I.y=c,t.target===e.canvas&&(t.preventDefault(),(h=q())&&h[i]&&h[i](t)),W[i]&&W[i](t,h)}I={x:0,y:0,radius:5,track(t){[].concat(t).map(function(t){t._r||(t._r=t.render,t.render=function(){k.push(this),this._r()},R.push(t))})},untrack(t,e){[].concat(t).map(function(t){t.render=t._r,t._r=e;let i=R.indexOf(t);-1!==i&&R.splice(i,1)})},over:t=>-1!==R.indexOf(t)&&q()===t,onDown(t){W.onDown=t},onUp(t){W.onUp=t},pressed:t=>!!D[t]},e.on("tick",()=>{z.length=0,k.map(function(t){z.push(t)}),k.length=0}),e.on("init",()=>{e.canvas.addEventListener("mousedown",F),e.canvas.addEventListener("touchstart",F),e.canvas.addEventListener("mouseup",U),e.canvas.addEventListener("touchend",U),e.canvas.addEventListener("blur",N),e.canvas.addEventListener("mousemove",$),e.canvas.addEventListener("touchmove",$)});var H=I;class J{constructor(t){t=t||{},this._c=t.create,this._i=0,this.objects=[t.create()],this.size=1,this.maxSize=t.maxSize||1024}get(t){if(t=t||{},this.objects.length==this._i){if(this.size===this.maxSize)return;for(let t=0;t<this.size&&this.objects.length<this.maxSize;t++)this.objects.unshift(this._c());this.size=this.objects.length}let e=this.objects.shift();return e.init(t),this.objects.push(e),this._i++,e}getAliveObjects(){return this.objects.slice(this.objects.length-this._i)}clear(){this._i=this.objects.length=0,this.size=1,this.objects.push(this._c())}update(t){let e,i=this.size-1,s=Math.max(this.objects.length-this._i,0);for(;i>=s;)(e=this.objects[i]).update(t),e.isAlive()?i--:(this.objects=this.objects.splice(i,1).concat(this.objects),this._i--,s++)}render(){let t=Math.max(this.objects.length-this._i,0);for(let e=this.size-1;e>=t;e--)this.objects[e].render()}}function X(t){return new J(t)}function Y(t,e){let i=[],s=e.x+e.width/2,n=e.y+e.height/2,h=t.y<n&&t.y+t.height>=e.y,o=t.y+t.height>=n&&t.y<e.y+e.height;return t.x<s&&t.x+t.width>=e.x&&(h&&i.push(0),o&&i.push(2)),t.x+t.width>=s&&t.x<e.x+e.width&&(h&&i.push(1),o&&i.push(3)),i}X.prototype=J.prototype;class Z{constructor(t){t=t||{},this.maxDepth=t.maxDepth||3,this.maxObjects=t.maxObjects||25,this._b=!1,this._d=t.depth||0,this.bounds=t.bounds||{x:0,y:0,width:e.canvas.width,height:e.canvas.height},this.objects=[],this.subnodes=[]}clear(){this.subnodes.map(function(t){t.clear()}),this._b=!1,this.objects.length=0}get(t){let e,i,s=[];for(;this.subnodes.length&&this._b;){for(e=Y(t,this.bounds),i=0;i<e.length;i++)s.push.apply(s,this.subnodes[e[i]].get(t));return s}return this.objects}add(){let t,e,i,s;for(e=0;e<arguments.length;e++)if(i=arguments[e],Array.isArray(i))this.add.apply(this,i);else if(this._b)this._a(i);else if(this.objects.push(i),this.objects.length>this.maxObjects&&this._d<this.maxDepth){for(this._s(),t=0;s=this.objects[t];t++)this._a(s);this.objects.length=0}}_a(t,e,i){for(e=Y(t,this.bounds),i=0;i<e.length;i++)this.subnodes[e[i]].add(t)}_s(t,e,i){if(this._b=!0,!this.subnodes.length)for(t=this.bounds.width/2|0,e=this.bounds.height/2|0,i=0;i<4;i++)this.subnodes[i]=G({bounds:{x:this.bounds.x+(i%2==1?t:0),y:this.bounds.y+(i>=2?e:0),width:t,height:e},depth:this._d+1,maxDepth:this.maxDepth,maxObjects:this.maxObjects})}}function G(t){return new Z(t)}G.prototype=Z.prototype;class K{constructor(t,e){this._x=t||0,this._y=e||0}add(t,e){return Q(this.x+(t.x||0)*(e||1),this.y+(t.y||0)*(e||1))}clamp(t,e,i,s){this._c=!0,this._a=t,this._b=e,this._d=i,this._e=s}get x(){return this._x}get y(){return this._y}set x(t){this._x=this._c?Math.min(Math.max(this._a,t),this._d):t}set y(t){this._y=this._c?Math.min(Math.max(this._b,t),this._e):t}}function Q(t,e){return new K(t,e)}Q.prototype=K.prototype;class V{init(t,i,s,n){for(i in t=t||{},this.position=Q(t.x,t.y),this.velocity=Q(t.dx,t.dy),this.acceleration=Q(t.ddx,t.ddy),this.width=this.height=this.rotation=0,this.ttl=1/0,this.anchor={x:0,y:0},this.context=e.context,t)this[i]=t[i];return(s=t.image)&&(this.image=s,this.width=void 0!==t.width?t.width:s.width,this.height=void 0!==t.height?t.height:s.height),this}get x(){return this.position.x}get y(){return this.position.y}get dx(){return this.velocity.x}get dy(){return this.velocity.y}get ddx(){return this.acceleration.x}get ddy(){return this.acceleration.y}get animations(){return this.anims}set x(t){this.position.x=t}set y(t){this.position.y=t}set dx(t){this.velocity.x=t}set dy(t){this.velocity.y=t}set ddx(t){this.acceleration.x=t}set ddy(t){this.acceleration.y=t}set animations(t){let e,i;for(e in this.anims={},t)this.anims[e]=t[e].clone(),i=i||this.anims[e];this.currentAnimation=i,this.width=this.width||i.width,this.height=this.height||i.height}isAlive(){return this.ttl>0}collidesWith(t){if(this.rotation||t.rotation)return null;let e=this.x-this.width*this.anchor.x,i=this.y-this.height*this.anchor.y,s=t.x,n=t.y;return t.anchor&&(s-=t.width*t.anchor.x,n-=t.height*t.anchor.y),e<s+t.width&&e+this.width>s&&i<n+t.height&&i+this.height>n}update(t){this.advance(t)}render(){this.draw()}playAnimation(t){this.currentAnimation=this.animations[t],this.currentAnimation.loop||this.currentAnimation.reset()}advance(t){this.velocity=this.velocity.add(this.acceleration,t),this.position=this.position.add(this.velocity,t),this.ttl--,this.currentAnimation&&this.currentAnimation.update(t)}draw(){let t=-this.width*this.anchor.x,e=-this.height*this.anchor.y;this.context.save(),this.context.translate(this.x,this.y),this.rotation&&this.context.rotate(this.rotation),this.image?this.context.drawImage(this.image,0,0,this.image.width,this.image.height,t,e,this.width,this.height):this.currentAnimation?this.currentAnimation.render({x:t,y:e,width:this.width,height:this.height,context:this.context}):(this.context.fillStyle=this.color,this.context.fillRect(t,e,this.width,this.height)),this.context.restore()}}function tt(t){return(new V).init(t)}tt.prototype=V.prototype;class et{constructor(t){t=t||{},this.animations={},this.image=t.image,this.frame={width:t.frameWidth,height:t.frameHeight,margin:t.frameMargin},this._f=t.image.width/t.frameWidth|0,this.createAnimations(t.animations)}createAnimations(t){let e,i,n,h;for(h in t)i=(e=t[h]).frames,n=[],[].concat(i).map(function(t){n=n.concat(this._p(t))},this),this.animations[h]=s({spriteSheet:this,frames:n,frameRate:e.frameRate,loop:e.loop})}_p(t,e){if(+t===t)return t;let i=[],s=t.split(".."),n=e=+s[0],h=+s[1];if(n<h)for(;e<=h;e++)i.push(e);else for(;e>=h;e--)i.push(e);return i}}function it(t){return new et(t)}it.prototype=et.prototype;const st={set(t,e){void 0===e?localStorage.removeItem(t):localStorage.setItem(t,JSON.stringify(e))},get(t){let e=localStorage.getItem(t);try{e=JSON.parse(e)}catch(t){}return e}};return e.assets=_,e.keys=E,e.plugin=P,e.pointer=H,e.store=st,e.animation=s,e.gameLoop=function(t){let i,s,n,h,o=(t=t||{}).fps||60,a=0,r=1e3/o,c=1/o,d=!1===t.clearCanvas?e._noop:function(){e.context.clearRect(0,0,e.canvas.width,e.canvas.height)};function u(){if(s=requestAnimationFrame(u),n=performance.now(),h=n-i,i=n,!(h>1e3)){for(e.emit("tick"),a+=h;a>=r;)l.update(c),a-=r;d(),l.render()}}let l={update:t.update,render:t.render,isStopped:!0,start(){i=performance.now(),this.isStopped=!1,requestAnimationFrame(u)},stop(){this.isStopped=!0,cancelAnimationFrame(s)}};return l},e.pool=X,e.quadtree=G,e.sprite=tt,e.spriteSheet=it,e.tileEngine=function(t){let i=t.width*t.tilewidth,s=t.height*t.tileheight,n=document.createElement("canvas"),h=n.getContext("2d");n.width=i,n.height=s;let o={},a={},r=Object.assign({mapwidth:i,mapheight:s,_sx:0,_sy:0,get sx(){return this._sx},get sy(){return this._sy},set sx(t){this._sx=Math.min(Math.max(0,t),i-e.canvas.width)},set sy(t){this._sy=Math.min(Math.max(0,t),s-e.canvas.height)},render(){u(n)},renderLayer(t){let e=a[t],n=o[t];e||((e=document.createElement("canvas")).width=i,e.height=s,a[t]=e,r._r(n,e.getContext("2d"))),u(e)},layerCollidesWith(t,e){let i=c(e.y),s=d(e.x),n=c(e.y+e.height),h=d(e.x+e.width),a=o[t];for(let t=i;t<=n;t++)for(let e=s;e<=h;e++)if(a.data[e+t*this.width])return!0;return!1},tileAtLayer(t,e){let i=e.row||c(e.y),s=e.col||d(e.x);return o[t]?o[t].data[s+i*r.width]:-1},_r:function(t,e){e.save(),e.globalAlpha=t.opacity,t.data.forEach((t,i)=>{if(!t)return;let s;for(let e=r.tilesets.length-1;e>=0&&(s=r.tilesets[e],!(t/s.firstgid>=1));e--);let n=s.tilewidth||r.tilewidth,h=s.tileheight||r.tileheight,o=s.margin||0,a=s.image,c=t-s.firstgid,d=s.columns||a.width/(n+o)|0,u=i%r.width*n,l=(i/r.width|0)*h,f=c%d*(n+o),g=(c/d|0)*(h+o);e.drawImage(a,f,g,n,h,u,l,n,h)}),e.restore()}},t);function c(t){return(r.sy+t)/r.tileheight|0}function d(t){return(r.sx+t)/r.tilewidth|0}function u(t){(r.context||e.context).drawImage(t,r.sx,r.sy,e.canvas.width,e.canvas.height,0,0,e.canvas.width,e.canvas.height)}return r.tilesets.forEach(i=>{let s=(e.assets?e.assets._d.get(t):"")||window.location.href;if(i.source){let t=e.assets.data[e.assets._u(i.source,s)];Object.keys(t).forEach(e=>{i[e]=t[e]})}if(""+i.image===i.image){let t=e.assets.images[e.assets._u(i.image,s)];i.image=t}}),r.layers&&r.layers.forEach(t=>{o[t.name]=t,!1!==t.visible&&r._r(t,h)}),r},e.vector=Q,e}();