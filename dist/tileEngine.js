!function(e,t,r){e.tileEngine=function(i){function a(e){var t,r;return"undefined"!=typeof e.x&&"undefined"!=typeof e.y?(t=j.getRow(e.y),r=j.getCol(e.x)):(t=e.row,r=e.col),t<0||r<0||t>=l||r>=f?-1:r+t*f}function n(e){for(var t,r,i=0,a=j.tilesets.length-1;i<=a;){if(t=(i+a)/2|0,r=j.tilesets[t],e>=r.firstGrid&&e<=r.lastGrid)return r;r.lastGrid<e?i=t+1:a=t-1}}function s(){for(var e,t,r,i,a,s,o,d,l,u,g=0;u=j.layers[G[g]];g++)for(var y=0,m=u.data.length;y<m;y++)e=u.data[y],e&&(t=n(e),r=t.image,i=y%f*c,a=(y/f|0)*h,d=e-t.firstGrid,l=r.width/c,s=d%l*c,o=(d/l|0)*h,v.drawImage(r,s,o,c,h,i,a,c,h))}if(i=i||{},!i.width||!i.height)throw Error("You must provide width and height properties");var o,d,f=i.width,l=i.height,c=i.tileWidth||i.tilewidth||32,h=i.tileHeight||i.tileheight||32,u=f*c,g=l*h,y=i.context||e.context,m=y.canvas.width,x=y.canvas.height,w=document.createElement("canvas"),v=w.getContext("2d"),p=t.max(0,u-m),b=t.max(0,g-x),G=[],j={width:f,height:l,tileWidth:c,tileHeight:h,context:y,x:i.x||0,y:i.y||0,tilesets:[],layers:{},addTilesets:function(t){r.isArray(t)||(t=[t]),t.forEach(function(t){var r,i,a,n,s,o=t.image;if(e._isImage(o))r=o;else if(e._isString(o))for(var d=1/0;d>=0;){d=o.lastIndexOf("/",d);var f=d<0?o:o.substr(d);if(e.assets.images[f]){r=e.assets.images[f];break}d--}if(!r)throw Error("You must provide an Image for the tileset");i=t.firstGrid,a=(r.width/c|0||1)*(r.height/h|0||1),i||(j.tilesets.length>0?(n=j.tilesets[j.tilesets.length-1],s=(n.image.width/c|0)*(n.image.height/h|0),i=n.firstGrid+s):i=1),j.tilesets.push({firstGrid:i,lastGrid:i+a-1,image:r}),j.tilesets.sort(function(e,t){return e.firstGrid-t.firstGrid})})},addLayers:function(e){r.isArray(e)||(e=[e]),e.forEach(function(e){e.render=void 0===e.render||e.render;var t,i,a,n,s,o;if(r.isArray(e.data[0]))for(t=[],i=0;a=e.data[i];i++)for(n=0;n<f;n++)t.push(a[n]||0);else t=e.data;j.layers[e.name]={data:t,zIndex:e.zIndex||0,render:e.render};for(s in e.properties){o=e.properties[s];try{o=JSON.parse(o)}catch(d){}j.layers[e.name][s]=o}j.layers[e.name].render&&(G.push(e.name),G.sort(function(e,t){return j.layers[e].zIndex-j.layers[t].zIndex}))}),s()},layerCollidesWith:function(e,t){for(var r,i=j.getRow(t.y),n=j.getCol(t.x),s=j.getRow(t.y+t.height),o=j.getCol(t.x+t.width),d=i;d<=s;d++)for(var f=n;f<=o;f++)if(r=a({row:d,col:f}),j.layers[e].data[r])return!0;return!1},tileAtLayer:function(e,t){var r=a(t);if(r>=0)return j.layers[e].data[r]},render:function(){j.context.drawImage(w,j.sx,j.sy,m,x,j.x,j.y,m,x)},renderLayer:function(e){for(var r,i,s,o,d,u,g,y,w,v=j.layers[e],p=j.getRow(),b=j.getCol(),G=a({row:p,col:b}),I=b*c-j.sx,O=p*h-j.sy,C=t.min(t.ceil(m/c)+1,f),E=t.min(t.ceil(x/h)+1,l),A=C*E,R=0;R<A;)s=v.data[G],s&&(o=n(s),d=o.image,r=I+R%C*c,i=O+(R/C|0)*h,u=s-o.firstGrid,g=d.width/c,y=u%g*c,w=(u/g|0)*h,j.context.drawImage(d,y,w,c,h,r,i,c,h)),++R%C===0?G=b+ ++p*f:G++},getRow:function(e){return e=e||0,(j.sy+e)/h|0},getCol:function(e){return e=e||0,(j.sx+e)/c|0},get sx(){return o},get sy(){return d},set sx(e){o=t.min(t.max(0,e),p)},set sy(e){d=t.min(t.max(0,e),b)},get _layerOrder(){return G}};j.sx=i.sx||0,j.sy=i.sy||0,w.width=u,w.height=g;for(var I in i.properties){var O=i.properties[I];try{O=JSON.parse(O)}catch(C){}j[I]=j[I]||O}return i.tilesets&&j.addTilesets(i.tilesets),i.layers&&j.addLayers(i.layers),j}}(kontra,Math,Array);