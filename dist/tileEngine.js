!function(h,L,g){h.tileEngine=function(e){function w(e){var t,r;return void 0!==e.x&&void 0!==e.y?(t=E.getRow(e.y),r=E.getCol(e.x)):(t=e.row,r=e.col),t<0||r<0||I<=t||G<=r?-1:r+t*G}function p(e){for(var t,r,i=0,a=E.tilesets.length-1;i<=a;){if(t=(i+a)/2|0,e>=(r=E.tilesets[t]).firstGrid&&e<=r.lastGrid)return r;r.lastGrid<e?i=t+1:a=t-1}}var t,r,G=(e=e||{}).width,I=e.height,C=e.tileWidth||e.tilewidth||32,A=e.tileHeight||e.tileheight||32,i=G*C,a=I*A,s=e.context||h.context,R=s.canvas.width,z=s.canvas.height,n=document.createElement("canvas"),c=n.getContext("2d"),d=L.max(0,i-R),o=L.max(0,a-z),y=[],E={width:G,height:I,tileWidth:C,tileHeight:A,mapWidth:i,mapHeight:a,context:s,x:e.x||0,y:e.y||0,tilesets:[],layers:{},addTilesets:function(e){g.isArray(e)||(e=[e]),e.forEach(function(e){var t,r,i,a,s,n=e.image;if(h._isImage(n))t=n;else if(h._isString(n))for(var d=1/0;0<=d;){var o=(d=n.lastIndexOf("/",d))<0?n:n.substr(d);if(h.assets.images[o]){t=h.assets.images[o];break}d--}r=e.firstGrid,i=(t.width/C|0||1)*(t.height/A|0||1),r||(0<E.tilesets.length?(s=((a=E.tilesets[E.tilesets.length-1]).image.width/C|0)*(a.image.height/A|0),r=a.firstGrid+s):r=1),E.tilesets.push({firstGrid:r,lastGrid:r+i-1,image:t}),E.tilesets.sort(function(e,t){return e.firstGrid-t.firstGrid})})},addLayers:function(e){g.isArray(e)||(e=[e]),e.forEach(function(e){var t,r,i,a,s,n;if(e.render=void 0===e.render||e.render,g.isArray(e.data[0]))for(t=[],r=0;i=e.data[r];r++)for(a=0;a<G;a++)t.push(i[a]||0);else t=e.data;for(s in E.layers[e.name]={data:t,zIndex:e.zIndex||0,render:e.render},e.properties){n=e.properties[s];try{n=JSON.parse(n)}catch(e){}E.layers[e.name][s]=n}E.layers[e.name].render&&(y.push(e.name),y.sort(function(e,t){return E.layers[e].zIndex-E.layers[t].zIndex}))}),function(){for(var e,t,r,i,a,s,n,d,o,l,f=0;l=E.layers[y[f]];f++)for(var h=0,g=l.data.length;h<g;h++)(e=l.data[h])&&(r=(t=p(e)).image,i=h%G*C,a=(h/G|0)*A,s=(d=e-t.firstGrid)%(o=r.width/C)*C,n=(d/o|0)*A,c.drawImage(r,s,n,C,A,i,a,C,A))}()},layerCollidesWith:function(e,t){for(var r,i=E.getRow(t.y),a=E.getCol(t.x),s=E.getRow(t.y+t.height),n=E.getCol(t.x+t.width),d=i;d<=s;d++)for(var o=a;o<=n;o++)if(r=w({row:d,col:o}),E.layers[e].data[r])return!0;return!1},tileAtLayer:function(e,t){var r=w(t);if(0<=r)return E.layers[e].data[r]},render:function(){E.context.drawImage(n,E.sx,E.sy,R,z,E.x,E.y,R,z)},renderLayer:function(e){for(var t,r,i,a,s,n,d,o,l,f=E.layers[e],h=E.getRow(),g=E.getCol(),c=w({row:h,col:g}),y=g*C-E.sx,u=h*A-E.sy,x=L.min(L.ceil(R/C)+1,G),m=x*L.min(L.ceil(z/A)+1,I),v=0;v<m;)(i=f.data[c])&&(s=(a=p(i)).image,t=y+v%x*C,r=u+(v/x|0)*A,o=(n=i-a.firstGrid)%(d=s.width/C)*C,l=(n/d|0)*A,E.context.drawImage(s,o,l,C,A,t,r,C,A)),++v%x==0?c=g+ ++h*G:c++},getRow:function(e){return e=e||0,(E.sy+e)/A|0},getCol:function(e){return e=e||0,(E.sx+e)/C|0},get sx(){return t},get sy(){return r},set sx(e){t=L.min(L.max(0,e),d)},set sy(e){r=L.min(L.max(0,e),o)},_layerOrder:y};for(var l in E.sx=e.sx||0,E.sy=e.sy||0,n.width=i,n.height=a,e.properties){var f=e.properties[l];try{f=JSON.parse(f)}catch(e){}E[l]=E[l]||f}return e.tilesets&&E.addTilesets(e.tilesets),e.layers&&E.addLayers(e.layers),E}}(kontra,Math,Array);