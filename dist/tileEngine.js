kontra.tileEngine=function(t){function w(t){var e,r;return void 0!==t.x&&void 0!==t.y?(e=z.getRow(t.y),r=z.getCol(t.x)):(e=t.row,r=t.col),e<0||r<0||M<=e||G<=r?-1:r+e*G}function p(t){for(var e,r,a=0,i=z.tilesets.length-1;a<=i;){if(e=(a+i)/2|0,t>=(r=z.tilesets[e]).firstGrid&&t<=r.lastGrid)return r;r.lastGrid<t?a=e+1:i=e-1}}var e,r,G=(t=t||{}).width,M=t.height,I=t.tileWidth||t.tilewidth||32,C=t.tileHeight||t.tileheight||32,a=G*I,i=M*C,s=t.context||kontra.context,k=s.canvas.width,R=s.canvas.height,n=document.createElement("canvas"),c=n.getContext("2d"),o=Math.max(0,a-k),d=Math.max(0,i-R),y=[],z={width:G,height:M,tileWidth:I,tileHeight:C,mapWidth:a,mapHeight:i,context:s,x:t.x||0,y:t.y||0,tilesets:[],layers:{},addTilesets:function(t){[].concat(t).map(function(t){var e,r,a,i,s,n=t.image;if(""+n===n)for(var o=1/0;0<=o;){var d=(o=n.lastIndexOf("/",o))<0?n:n.substr(o);if(kontra.assets.images[d]){e=kontra.assets.images[d];break}o--}else e=n;r=t.firstGrid,a=(e.width/I|0||1)*(e.height/C|0||1),r||(0<z.tilesets.length?(s=((i=z.tilesets[z.tilesets.length-1]).image.width/I|0)*(i.image.height/C|0),r=i.firstGrid+s):r=1),z.tilesets.push({firstGrid:r,lastGrid:r+a-1,image:e}),z.tilesets.sort(function(t,e){return t.firstGrid-e.firstGrid})})},addLayers:function(t){[].concat(t).map(function(t){var e,r,a,i,s,n;if(t.render=void 0===t.render||t.render,Array.isArray(t.data[0]))for(e=[],r=0;a=t.data[r];r++)for(i=0;i<G;i++)e.push(a[i]||0);else e=t.data;for(s in z.layers[t.name]={data:e,zIndex:t.zIndex||0,render:t.render},t.properties){n=t.properties[s];try{n=JSON.parse(n)}catch(t){}z.layers[t.name][s]=n}z.layers[t.name].render&&(y.push(t.name),y.sort(function(t,e){return z.layers[t].zIndex-z.layers[e].zIndex}))}),function(){for(var t,e,r,a,i,s,n,o,d,l,h=0;l=z.layers[y[h]];h++)for(var f=0,g=l.data.length;f<g;f++)(t=l.data[f])&&(r=(e=p(t)).image,a=f%G*I,i=(f/G|0)*C,s=(o=t-e.firstGrid)%(d=r.width/I)*I,n=(o/d|0)*C,c.drawImage(r,s,n,I,C,a,i,I,C))}()},layerCollidesWith:function(t,e){for(var r,a=z.getRow(e.y),i=z.getCol(e.x),s=z.getRow(e.y+e.height),n=z.getCol(e.x+e.width),o=a;o<=s;o++)for(var d=i;d<=n;d++)if(r=w({row:o,col:d}),z.layers[t].data[r])return!0;return!1},tileAtLayer:function(t,e){var r=w(e);if(0<=r)return z.layers[t].data[r]},render:function(){z.context.drawImage(n,z.sx,z.sy,k,R,z.x,z.y,k,R)},renderLayer:function(t){for(var e,r,a,i,s,n,o,d,l,h=z.layers[t],f=z.getRow(),g=z.getCol(),c=w({row:f,col:g}),y=g*I-z.sx,u=f*C-z.sy,m=Math.min(Math.ceil(k/I)+1,G),x=m*Math.min(Math.ceil(R/C)+1,M),v=0;v<x;)(a=h.data[c])&&(s=(i=p(a)).image,e=y+v%m*I,r=u+(v/m|0)*C,d=(n=a-i.firstGrid)%(o=s.width/I)*I,l=(n/o|0)*C,z.context.drawImage(s,d,l,I,C,e,r,I,C)),++v%m==0?c=g+ ++f*G:c++},getRow:function(t){return t=t||0,(z.sy+t)/C|0},getCol:function(t){return t=t||0,(z.sx+t)/I|0},get sx(){return e},get sy(){return r},set sx(t){e=Math.min(Math.max(0,t),o)},set sy(t){r=Math.min(Math.max(0,t),d)}};for(var l in z.sx=t.sx||0,z.sy=t.sy||0,n.width=a,n.height=i,t.properties){var h=t.properties[l];try{h=JSON.parse(h)}catch(t){}z[l]=z[l]||h}return t.tilesets&&z.addTilesets(t.tilesets),t.layers&&z.addLayers(t.layers),z};