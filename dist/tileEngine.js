var kontra=function(t,i,e){"use strict";return t.tileEngine=function(i){var e=Object.create(t.tileEngine.prototype);return e._init(i),e},t.tileEngine.prototype={_init:function(e){if(e=e||{},!e.width||!e.height){var h=new ReferenceError("Required parameters not found");return void t._logError(h,"You must provide width and height of the map to create a tile engine.")}this.width=e.width,this.height=e.height,this.tileWidth=e.tileWidth||32,this.tileHeight=e.tileHeight||32,this.context=e.context||t.context,this.canvasWidth=this.context.canvas.width,this.canvasHeight=this.context.canvas.height,this._offscreenCanvas=document.createElement("canvas"),this._offscreenContext=this._offscreenCanvas.getContext("2d"),this._offscreenCanvas.width=this.mapWidth=this.width*this.tileWidth,this._offscreenCanvas.height=this.mapHeight=this.height*this.tileHeight,this.sxMax=i.max(0,this.mapWidth-this.canvasWidth),this.syMax=i.max(0,this.mapHeight-this.canvasHeight),this.layers={},this._layerOrder=[],this.tilesets=[],this.x=e.x||0,this.y=e.y||0,this.sx=e.sx||0,this.sy=e.sy||0},addTileset:function(i){if(i=i||{},!t._isImage(i.image)&&!t._isCanvas(i.image)){var e=new SyntaxError("Invalid image.");return void t._logError(e,"You must provide an Image for the tile engine.")}var h=i.image,s=i.firstGrid,r=(h.width/this.tileWidth|0||1)*(h.height/this.tileHeight|0||1);if(!s)if(this.tilesets.length>0){var n=this.tilesets[this.tilesets.length-1],a=(n.image.width/this.tileWidth|0)*(n.image.height/this.tileHeight|0);s=n.firstGrid+a}else s=1;this.tilesets.push({firstGrid:s,lastGrid:s+r-1,image:h}),this.tilesets.sort(function(t,i){return t.firstGrid-i.firstGrid})},addLayer:function(t){t=t||{},t.render=t.render===e||t.render;var i;if(Array.isArray(t.data[0])){i=[];for(var h,s=0;h=t.data[s];s++)for(var r=0;r<this.width;r++)i.push(h[r]||0)}else i=t.data;this.layers[t.name]=i,this.layers[t.name].zIndex=t.zIndex||0,this.layers[t.name].render=t.render,t.render&&(this._layerOrder.push(t.name),this._layerOrder.sort(function(t,i){return this.layers[t].zIndex-this.layers[i].zIndex}.bind(this)),this._preRenderImage())},layerCollidesWith:function(t,i){for(var e,h=this.getRow(i.y),s=this.getCol(i.x),r=this.getRow(i.y+i.height),n=this.getCol(i.x+i.width),a=h;a<=r;a++)for(var d=s;d<=n;d++)if(e=this._getIndex({row:a,col:d}),this.layers[t][e])return!0;return!1},tileAtLayer:function(t,i){var e=this._getIndex(i);if(e>=0)return this.layers[t][e]},render:function(){this.sx=i.min(i.max(this.sx,0),this.sxMax),this.sy=i.min(i.max(this.sy,0),this.syMax),this.context.drawImage(this._offscreenCanvas,this.sx,this.sy,this.canvasWidth,this.canvasHeight,this.x,this.y,this.canvasWidth,this.canvasHeight)},renderLayer:function(t){for(var e,h,s,r,n,a,d,l,o,g=this.layers[t],f=this.getRow(),c=this.getCol(),x=this._getIndex({row:f,col:c}),u=c*this.tileWidth-this.sx,v=f*this.tileHeight-this.sy,y=i.min(i.ceil(this.canvasWidth/this.tileWidth)+1,this.width),m=i.min(i.ceil(this.canvasHeight/this.tileHeight)+1,this.height),w=y*m,W=0;W<w;)s=g[x],s&&(r=this._getTileset(s),n=r.image,e=u+W%y*this.tileWidth,h=v+(W/y|0)*this.tileHeight,a=s-r.firstGrid,d=n.width/this.tileWidth,l=a%d*this.tileWidth,o=(a/d|0)*this.tileHeight,this.context.drawImage(n,l,o,this.tileWidth,this.tileHeight,e,h,this.tileWidth,this.tileHeight)),++W%y===0?x=c+ ++f*this.width:x++},getRow:function(t){return t=t||0,(this.sy+t)/this.tileHeight|0},getCol:function(t){return t=t||0,(this.sx+t)/this.tileWidth|0},_getIndex:function(t){var i,e;return"undefined"!=typeof t.x&&"undefined"!=typeof t.y?(i=this.getRow(t.y),e=this.getCol(t.x)):(i=t.row,e=t.col),i<0||e<0||i>=this.height||e>=this.width?-1:e+i*this.width},_getTileset:function(t){for(var i,e,h=0,s=this.tilesets.length-1;h<=s;){if(i=(h+s)/2|0,e=this.tilesets[i],t>=e.firstGrid&&t<=e.lastGrid)return e;e.lastGrid<t?h=i+1:s=i-1}},_preRenderImage:function(){for(var t,i,e,h,s,r,n,a,d,l,o=0;l=this.layers[this._layerOrder[o]];o++)for(var g=0,f=l.length;g<f;g++)t=l[g],t&&(i=this._getTileset(t),e=i.image,h=g%this.width*this.tileWidth,s=(g/this.width|0)*this.tileHeight,a=t-i.firstGrid,d=e.width/this.tileWidth,r=a%d*this.tileWidth,n=(a/d|0)*this.tileHeight,this._offscreenContext.drawImage(e,r,n,this.tileWidth,this.tileHeight,h,s,this.tileWidth,this.tileHeight))}},t}(kontra||{},Math);